<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVE Ltd. Performance Appraisal Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #4A4A4A;
        }
        .rag-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }
        .bg-rag-green { background-color: #dcfce7; color: #166534; } /* green-100, green-800 */
        .bg-rag-amber { background-color: #fef3e2; color: #c26c04; } /* orange-100, orange-800 based on #F7A721 */
        .bg-rag-red   { background-color: #fee2e2; color: #991b1b; } /* red-100, red-800 */
        .bg-rag-none  { background-color: #ffffff; color: #475569; } /* white bg */

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media print {
            body {
                background-color: #ffffff;
                font-size: 10pt; /* Smaller base font for print */
            }
            .no-print {
                display: none !important;
            }
            .printable-area {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0.5rem; /* Add a little padding for print margins */
            }
            /* Reduce spacing & sizes */
            header.text-center {
                margin-bottom: 1rem;
                padding-bottom: 1rem;
            }
            header.text-center h1 {
                font-size: 2.5rem; /* Smaller logo */
                margin-bottom: 0.25rem;
            }
            header.text-center p {
                font-size: 0.9rem;
            }
            section {
                padding: 0.75rem;
                margin-bottom: 1rem;
                page-break-inside: avoid; /* Keep sections from splitting across pages */
            }
            h2 { font-size: 1.2rem; margin-bottom: 0.5rem; }
            h3 { font-size: 1rem; margin-bottom: 0.5rem; }

            textarea {
                padding: 4px;
                min-height: 40px !important;
            }
            /* Hide the example box */
            .smart-example {
                display: none;
            }
            .objective-card, .objective-card > div {
                margin-top: 0.5rem; /* Reduce space inside cards */
            }
            /* Reduce table cell padding */
            table th, table td {
                padding-top: 4px;
                padding-bottom: 4px;
                padding-left: 6px;
                padding-right: 6px;
            }
            /* Tighter list for values */
            .list-disc {
                margin-top: 0.25rem;
            }
            /* Compact the objective cards container */
            #objectivesContainer {
                --tw-space-y-reverse: 0;
                margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
                margin-bottom: calc(1rem * var(--tw-space-y-reverse));
            }
            #objectivesContainer > :not([hidden]) ~ :not([hidden]) {
                --tw-space-y-reverse: 0;
                margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
                margin-bottom: calc(1rem * var(--tw-space-y-reverse));
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 printable-area">
        <!-- Header -->
        <header class="text-center mb-8 border-b pb-6">
            <div class="mb-4">
                <h1 class="text-7xl font-bold tracking-wider" style="color: #007B80;">AVE</h1>
                <p class="text-sm font-semibold tracking-wider" style="color: #4A4A4A;">ADDED VALUE ENTERPRISES LTD.</p>
            </div>
            <p class="text-xl text-[#007B80]">Annual Performance Appraisal</p>
        </header>

        <!-- Colleague & Period Details -->
        <section class="bg-[#d1e5e6] p-6 rounded-xl shadow-md border border-slate-200 mb-8">
            <h2 class="text-xl font-bold mb-4 text-[#4A4A4A]">Appraisal Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="colleagueName" class="block text-sm font-medium text-slate-700 mb-1">Colleague Name</label>
                    <input type="text" id="colleagueName" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]">
                </div>
                <div>
                    <label for="managerName" class="block text-sm font-medium text-slate-700 mb-1">Manager Name</label>
                    <input type="text" id="managerName" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]">
                </div>
                <div>
                    <label for="appraisalPeriod" class="block text-sm font-medium text-slate-700 mb-1">Appraisal Period (e.g., Oct 25 - Sep 26)</label>
                    <input type="text" id="appraisalPeriod" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]">
                </div>
                <div>
                    <label for="reviewDate" class="block text-sm font-medium text-slate-700 mb-1">Date of Final Review</label>
                    <input type="date" id="reviewDate" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]">
                </div>
            </div>
        </section>
        
        <!-- Vision & Values Reminder -->
        <section class="bg-[#fef9e7] border-l-4 border-[#F7A721] text-[#92400e] p-6 rounded-r-lg mb-8">
            <h3 class="text-lg font-bold mb-2">AVE Vision & Values Reminder</h3>
            <p class="font-semibold">Nourishing Success: <span class="font-normal">Empowering growth through exceptional service and tailored solutions.</span></p>
            <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                <li><span class="font-semibold">Service Excellence:</span> Deliver exceptional, respectful, and honest service.</li>
                <li><span class="font-semibold">Innovation and Adaptability:</span> Innovate, experiment, improve, value feedback.</li>
                <li><span class="font-semibold">Partnership and Collaboration:</span> Foster respectful, transparent, collaborative relationships.</li>
                <li><span class="font-semibold">Commitment to Excellence:</span> High standards, accountability, continuous improvement, culture.</li>
            </ul>
        </section>

        <!-- Objectives Container -->
        <div id="objectivesContainer" class="space-y-8">
            <!-- This will be populated by the script -->
        </div>

        <!-- Add Objective Button -->
        <div class="mt-8 text-center no-print">
            <button onclick="addNewObjective()" class="bg-white text-[#007B80] font-bold py-2 px-6 rounded-lg border-2 border-[#007B80] hover:bg-[#d1e5e6] transition duration-200 shadow-sm">
                + Add another Objective
            </button>
        </div>

        <!-- Overall Summary -->
        <section class="bg-[#d1e5e6] p-6 rounded-xl shadow-md border border-slate-200 mt-8">
            <h2 class="text-xl font-bold mb-4 text-[#4A4A4A]">Overall Performance Summary</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                <div>
                    <label for="managerSummary" class="block text-sm font-medium text-slate-700 mb-1">Manager's overall comments and summary.</label>
                    <textarea id="managerSummary" rows="5" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]" placeholder="Summarize key achievements, areas for development, and next steps..."></textarea>
                </div>
                 <div>
                    <label for="colleagueSummary" class="block text-sm font-medium text-slate-700 mb-1">Colleague's overall comments & reflections.</label>
                    <textarea id="colleagueSummary" rows="5" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]" placeholder="Reflect on your achievements, challenges, and the support you received..."></textarea>
                </div>
            </div>
            <div class="mt-4 flex justify-end items-center">
                <div class="text-left mr-4">
                    <label for="overallRag" class="block text-sm font-medium text-slate-700 mb-1">Overall RAG Rating</label>
                    <span id="suggestedRag" class="text-xs text-slate-500">Suggested: ---</span>
                </div>
                <select id="overallRag" onchange="updateRagColor(this)" class="rag-select w-full md:w-1/4 p-2 border border-slate-300 rounded-md shadow-sm font-medium text-sm focus:ring-[#007B80] focus:border-[#007B80] bg-rag-none transition-colors duration-200 h-10">
                    <option value="None">Select...</option>
                    <option value="Green">Green</option>
                    <option value="Amber">Amber</option>
                    <option value="Red">Red</option>
                </select>
            </div>
        </section>
        
        <!-- Personal Development -->
        <section class="bg-[#d1e5e6] p-6 rounded-xl shadow-md border border-slate-200 mt-8">
            <h2 class="text-xl font-bold mb-4 text-[#4A4A4A]">Personal Development & Future Goals</h2>
            <div class="space-y-4">
                <div>
                    <label for="devAreas" class="block text-sm font-medium text-slate-700 mb-1">Areas for development or skills I'd like to improve.</label>
                    <textarea id="devAreas" rows="3" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]"></textarea>
                </div>
                 <div>
                    <label for="devSupport" class="block text-sm font-medium text-slate-700 mb-1">Support I would need to achieve these goals (e.g., training, mentoring).</label>
                    <textarea id="devSupport" rows="3" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]"></textarea>
                </div>
                 <div>
                    <label for="careerAspirations" class="block text-sm font-medium text-slate-700 mb-1">My career aspirations for the next 6-12 months.</label>
                    <textarea id="careerAspirations" rows="3" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]"></textarea>
                </div>
            </div>
        </section>


        <!-- Action Buttons -->
        <div class="mt-10 text-center no-print flex flex-wrap justify-center gap-4">
            <input type="file" id="loadDataInput" onchange="loadData(event)" accept=".json" class="hidden">
            <button onclick="document.getElementById('loadDataInput').click()" class="bg-white text-[#F7A721] font-bold py-2 px-6 rounded-lg border-2 border-[#F7A721] hover:bg-[#fef9e7] transition duration-200 shadow-sm">
                Load Data
            </button>
            <button onclick="saveData()" class="bg-[#F7A721] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#dd961e] transition duration-200 shadow-sm">
                Save Data
            </button>
            <button onclick="window.print()" class="bg-[#007B80] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#006064] transition duration-200 shadow-md">
                Save as PDF / Print
            </button>
            <button onclick="resetForm()" class="bg-[#4A4A4A] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#383838] transition duration-200 shadow-md">
                Clear Form
            </button>
        </div>
    </div>

    <script>
        const objectivesContainer = document.getElementById('objectivesContainer');
        let objectiveCounter = 0;

        const values = [
            { id: 'serviceExcellence', name: 'Service Excellence' },
            { id: 'innovation', name: 'Innovation and Adaptability' },
            { id: 'partnership', name: 'Partnership and Collaboration' },
            { id: 'commitment', name: 'Commitment to Excellence' },
            { id: 'commercial', name: 'Commercial' }
        ];

        // --- RAG Calculation Logic ---
        function calculateAverageRag() {
            const allRatings = document.querySelectorAll('.objective-card .rag-select');
            const suggestionEl = document.getElementById('suggestedRag');
            let totalScore = 0;
            let ratedCount = 0;

            allRatings.forEach(select => {
                switch (select.value) {
                    case 'Green':
                        totalScore += 3;
                        ratedCount++;
                        break;
                    case 'Amber':
                        totalScore += 2;
                        ratedCount++;
                        break;
                    case 'Red':
                        totalScore += 1;
                        ratedCount++;
                        break;
                }
            });

            if (ratedCount === 0) {
                suggestionEl.innerHTML = 'Suggested: ---';
                return;
            }

            const average = totalScore / ratedCount;
            let suggestion = '---';
            let colorClass = 'text-slate-500';

            if (average >= 2.5) {
                suggestion = 'Green';
                colorClass = 'text-green-700';
            } else if (average >= 1.5) {
                suggestion = 'Amber';
                colorClass = 'text-amber-700';
            } else {
                suggestion = 'Red';
                colorClass = 'text-red-700';
            }
            
            suggestionEl.innerHTML = `Suggested: <span class="font-bold ${colorClass}">${suggestion}</span>`;
        }

        function updateRagColor(element) {
            const selectedValue = element.value;
            element.classList.remove('bg-rag-green', 'bg-rag-amber', 'bg-rag-red', 'bg-rag-none');
            if (selectedValue === 'Green') {
                element.classList.add('bg-rag-green');
            } else if (selectedValue === 'Amber') {
                element.classList.add('bg-rag-amber');
            } else if (selectedValue === 'Red') {
                element.classList.add('bg-rag-red');
            } else {
                element.classList.add('bg-rag-none');
            }
            // Recalculate average if the changed element is part of an objective
            if(element.closest('.objective-card')) {
                calculateAverageRag();
            }
        }

        // --- Dynamic Row & Card Creation Logic ---
        function createReviewRowHTML(periodValue = "", reviewData = null) {
             let periodCellHTML;
             // Allow editing of the default period as well
             periodCellHTML = `<input type="text" class="period-input w-full text-sm p-2 border border-slate-200 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]" value="${periodValue}" placeholder="Custom Period...">`;
             
             // If reviewData is provided, pre-fill the row
             const managerComment = reviewData ? reviewData.managerComment : "";
             const colleagueComment = reviewData ? reviewData.colleagueComment : "";
             const status = reviewData ? reviewData.status : "None";

            const row = document.createElement('tr');
            row.className = 'border-b border-slate-200';
            row.innerHTML = `
                <td class="py-2 px-3">${periodCellHTML}</td>
                <td class="py-2 px-3">
                    <textarea rows="2" class="manager-comment w-full text-sm p-2 border border-slate-200 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]" placeholder="Manager's comments...">${managerComment}</textarea>
                </td>
                <td class="py-2 px-3">
                    <textarea rows="2" class="colleague-comment w-full text-sm p-2 border border-slate-200 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]" placeholder="Colleague's comments...">${colleagueComment}</textarea>
                </td>
                <td class="py-2 px-3">
                    <select onchange="updateRagColor(this)" class="rag-select w-full p-2 border border-slate-300 rounded-md shadow-sm font-medium text-sm focus:ring-[#007B80] focus:border-[#007B80] bg-rag-none transition-colors duration-200">
                        <option value="None" ${status === 'None' ? 'selected' : ''}>Select...</option>
                        <option value="Green" ${status === 'Green' ? 'selected' : ''}>Green</option>
                        <option value="Amber" ${status === 'Amber' ? 'selected' : ''}>Amber</option>
                        <option value="Red" ${status === 'Red' ? 'selected' : ''}>Red</option>
                    </select>
                </td>
                <td class="py-2 px-3 text-center no-print">
                    <button onclick="deleteReviewPeriod(this)" class="text-red-600 hover:text-red-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;
            
            // Apply RAG color on load
            if (reviewData) {
                updateRagColor(row.querySelector('.rag-select'));
            }
            return row;
        }

        function addReviewPeriod(button) {
            const tableBody = button.closest('.mt-6').querySelector('tbody');
            const newRow = createReviewRowHTML("");
            tableBody.appendChild(newRow);
        }

        function deleteReviewPeriod(button) {
            const row = button.closest('tr');
            row.remove();
            calculateAverageRag();
        }
        
        function deleteObjective(button) {
            const card = button.closest('.objective-card');
            card.remove();
            calculateAverageRag();
        }

        function createObjectiveCard(objectiveId, objectiveData = null) {
            const valueCheckboxes = values.map(value => {
                const isChecked = objectiveData ? objectiveData.values.includes(value.id) : false;
                return `
                <div class="flex items-center">
                    <input id="value-${value.id}-${objectiveId}" name="value-${objectiveId}" type="checkbox" class="value-checkbox h-4 w-4 text-[#007B80] border-slate-300 rounded focus:ring-[#007B80]" data-value-id="${value.id}" ${isChecked ? 'checked' : ''}>
                    <label for="value-${value.id}-${objectiveId}" class="ml-2 block text-sm text-slate-800">${value.name}</label>
                </div>
            `}).join('');

            const description = objectiveData ? objectiveData.description : "";

            const card = document.createElement('div');
            card.className = 'bg-[#d1e5e6] p-6 rounded-xl shadow-md border border-slate-200 objective-card relative';
            card.innerHTML = `
                <button onclick="deleteObjective(this)" class="absolute top-4 right-4 text-slate-400 hover:text-red-600 transition-colors no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold mb-4 text-[#4A4A4A]">Objective ${objectiveId}</h2>
                
                <div>
                    <label for="objective-desc-${objectiveId}" class="block text-sm font-medium text-slate-700 mb-1">SMART Objective Description</label>
                    <textarea id="objective-desc-${objectiveId}" rows="4" class="objective-description w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#007B80] focus:border-[#007B80]" placeholder="Specific, Measurable, Achievable, Relevant, Time-Bound...">${description}</textarea>
                    <div class="mt-2 p-3 bg-white/70 rounded-md text-xs text-slate-600 border border-slate-200 smart-example">
                        <p><b class="font-semibold">Example of a SMART Objective:</b> "Increase my personal client satisfaction score from 85% to 90% by the end of Q2 by implementing a new monthly check-in call with all my key accounts."</p>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-md font-semibold text-slate-700 mb-3">Link to Company Values</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                        ${valueCheckboxes}
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-md font-semibold text-slate-700 mb-3">Review & Progress</h3>
                    <div class="overflow-x-auto rounded-lg border border-slate-200 bg-white">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-2/12">Period</th>
                                    <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-4/12">Manager's Comments</th>
                                    <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-4/12">Colleague's Comments</th>
                                    <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-1/12">Status</th>
                                    <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-1/12 no-print">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Review rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right mt-2 no-print">
                        <button onclick="addReviewPeriod(this)" class="text-sm bg-[#007B80] text-white font-semibold py-1 px-3 rounded-md hover:bg-[#006064] transition-colors">+ Add Period</button>
                    </div>
                </div>
            `;
            
            // Add review rows
            const tableBody = card.querySelector('tbody');
            if (objectiveData && objectiveData.reviews.length > 0) {
                objectiveData.reviews.forEach(review => {
                    const reviewRow = createReviewRowHTML(review.period, review);
                    tableBody.appendChild(reviewRow);
                });
            } else {
                // Add the default first row if no data
                const initialReview = createReviewRowHTML("Q1 (Oct-Dec)");
                tableBody.appendChild(initialReview);
            }
            
            return card;
        }
        
        function addNewObjective(objectiveData = null) {
            objectiveCounter++;
            const newObjectiveCard = createObjectiveCard(objectiveCounter, objectiveData);
            objectivesContainer.appendChild(newObjectiveCard);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the 3 default objectives
            for (let i = 0; i < 3; i++) {
                addNewObjective();
            }
        });

        function resetForm() {
            // Replaced confirm() with a simple console log and proceeding, as confirm() is not allowed.
            // In a real app, you'd build a custom modal here.
            console.log("Form reset requested. Proceeding without confirmation.");
            
            // Clear basic fields
            document.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el => el.value = '');
            
            // Reset objectives
            objectivesContainer.innerHTML = '';
            objectiveCounter = 0;
            for (let i = 0; i < 3; i++) {
                addNewObjective();
            }
            
            // Reset overall RAG
            const overallRagSelect = document.getElementById('overallRag');
            overallRagSelect.value = 'None';
            updateRagColor(overallRagSelect);
            
            calculateAverageRag();
        }

        // --- Save / Load Logic ---

        function saveData() {
            const colleagueName = document.getElementById('colleagueName').value;
            const appraisalData = {
                colleagueName: colleagueName,
                managerName: document.getElementById('managerName').value,
                appraisalPeriod: document.getElementById('appraisalPeriod').value,
                reviewDate: document.getElementById('reviewDate').value,
                objectives: [],
                managerSummary: document.getElementById('managerSummary').value,
                colleagueSummary: document.getElementById('colleagueSummary').value,
                overallRag: document.getElementById('overallRag').value,
                devAreas: document.getElementById('devAreas').value,
                devSupport: document.getElementById('devSupport').value,
                careerAspirations: document.getElementById('careerAspirations').value
            };

            // Loop through each objective card
            document.querySelectorAll('.objective-card').forEach(card => {
                const objective = {
                    description: card.querySelector('.objective-description').value,
                    values: [],
                    reviews: []
                };

                // Get checked values
                card.querySelectorAll('.value-checkbox:checked').forEach(checkbox => {
                    objective.values.push(checkbox.dataset.valueId);
                });

                // Get review rows
                card.querySelectorAll('tbody tr').forEach(row => {
                    const review = {
                        period: row.querySelector('.period-input').value,
                        managerComment: row.querySelector('.manager-comment').value,
                        colleagueComment: row.querySelector('.colleague-comment').value,
                        status: row.querySelector('.rag-select').value
                    };
                    objective.reviews.push(review);
                });

                appraisalData.objectives.push(objective);
            });

            // Create and download the file
            const dataStr = JSON.stringify(appraisalData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fileName = colleagueName ? `${colleagueName.replace(/ /g, '_')}_Appraisal.json` : 'appraisal_data.json';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    // Clear existing form
                    objectivesContainer.innerHTML = '';
                    objectiveCounter = 0;

                    // Populate basic info
                    document.getElementById('colleagueName').value = loadedData.colleagueName || '';
                    document.getElementById('managerName').value = loadedData.managerName || '';
                    document.getElementById('appraisalPeriod').value = loadedData.appraisalPeriod || '';
                    document.getElementById('reviewDate').value = loadedData.reviewDate || '';

                    // Populate objectives
                    if (loadedData.objectives && loadedData.objectives.length > 0) {
                        loadedData.objectives.forEach(objectiveData => {
                            addNewObjective(objectiveData);
                        });
                    } else {
                        // If no objectives in file, add 3 blank ones
                        for (let i = 0; i < 3; i++) {
                            addNewObjective();
                        }
                    }

                    // Populate summary
                    document.getElementById('managerSummary').value = loadedData.managerSummary || '';
                    document.getElementById('colleagueSummary').value = loadedData.colleagueSummary || '';
                    const overallRagSelect = document.getElementById('overallRag');
                    overallRagSelect.value = loadedData.overallRag || 'None';
                    updateRagColor(overallRagSelect);

                    // Populate personal development
                    document.getElementById('devAreas').value = loadedData.devAreas || '';
                    document.getElementById('devSupport').value = loadedData.devSupport || '';
                    document.getElementById('careerAspirations').value = loadedData.careerAspirations || '';

                    // Recalculate average RAG
                    calculateAverageRag();
                    
                    // Clear the file input for re-use
                    event.target.value = null;

                } catch (error) {
                    console.error("Error parsing JSON file:", error);
                    // Can't use alert, log to console
                    console.error("There was an error loading the file. Please ensure it is a valid appraisal data file.");
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>

